"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.PluginAdapter = void 0;
const config_adapter_1 = require("./adapter/config-adapter");
const height_adapter_1 = require("./adapter/height-adapter");
const init_adapter_1 = require("./adapter/init-adapter");
const jwk_defaults_1 = require("./jwt/jwk-defaults");
const jwk_store_1 = require("./jwt/jwk-store");
const nest_1 = require("./utils/nest");
/**
 * The main service class to be used by a plug-in to establish a safe and secure
 * communication to the COYO front end bridge. It acts as a unified interaction
 * interface to all other plug-in handlers.
 */
class PluginAdapter {
    /**
     * Creates a new instance of this class.
     *
     * @param srcId the plug-in source ID to use for requests
     * @returns the new instance
     */
    constructor(srcId) {
        this.srcId = srcId || new URL(window.location.href).searchParams.get('src') || '';
        this.jwkStore = jwk_store_1.JwkStore.getInstance();
        this.initAdapter = new init_adapter_1.InitAdapter(this.srcId);
        this.initConfigAdapter = new init_adapter_1.InitAdapter(this.srcId + PluginAdapter.CONFIG_SRC_SUFFIX);
        this.heightAdapter = new height_adapter_1.HeightAdapter(this.srcId);
        this.heightConfigAdapter = new height_adapter_1.HeightAdapter(this.srcId + PluginAdapter.CONFIG_SRC_SUFFIX);
        this.configAdapter = new config_adapter_1.ConfigAdapter(this.srcId + PluginAdapter.CONFIG_SRC_SUFFIX);
        this.jwkStore.addHost('https://certificates.plugins.coyoapp.com');
        this.jwkStore.addJwk(jwk_defaults_1.JWK_STAGE_RGX, jwk_defaults_1.JWK_STAGE, jwk_defaults_1.JWK_STAGE_NEW);
        this.jwkStore.addJwk(jwk_defaults_1.JWK_PROD_RGX, jwk_defaults_1.JWK_PROD, jwk_defaults_1.JWK_PROD_NEW);
    }
    /**
     * Sends an initialization message to the parent window (i.e. COYO)
     * and retrieves the decoded (and possibly validated) response as well as the
     * raw token response.
     *
     * @param config a flag indicating if the plugin configuration view should be initialized
     * @param timeout a maximum time to wait for the response
     * @param validate a flag indicating if the JWT response should be validated
     * @returns a promise holding the response data
     */
    init(config = false, timeout = 60000, validate = true) {
        const adapter = config ? this.initConfigAdapter : this.initAdapter;
        return adapter.send(timeout, validate).then(([claims, token]) => {
            if (config) {
                this.configAdapter.bind(claims['ctx.userId']);
            }
            return { claims: nest_1.nest(claims), token, validated: validate };
        });
    }
    /**
     * Starts to listen to COYO requests to save the current configuration.
     * Provides a `respond` callback that is used to respond to the received
     * message. The response can be `true` to indicate success without providing
     * any data, `false` to indicate failure (e.g. an invalid configuration state)
     * or a JSON object holding the configuration values to be stored on COYO
     * side.
     *
     * @param cb a callback that is executed every time a save request is received
     * @param validate a flag indicating if the JWT response should be validated
     * @returns a disconnect handler to stop listening to save events
     */
    onSave(cb, validate = true) {
        this.configAdapter.connect(cb, validate);
        return () => this.configAdapter.disconnect();
    }
    /**
     * Starts to observe the HTML element that matches the given selectors and
     * sends throttled update messages to COYO.
     *
     * @param config a flag indicating if the plugin configuration view should be observed
     * @param selectors the selectors to target the HTML element
     * @returns a disconnect handler to stop observing the HTML element
     */
    observeHeight(config = false, selectors = 'html') {
        const adapter = config ? this.heightConfigAdapter : this.heightAdapter;
        adapter.connect(selectors, 50);
        return () => adapter.disconnect();
    }
}
exports.PluginAdapter = PluginAdapter;
PluginAdapter.CONFIG_SRC_SUFFIX = '-cfg';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGx1Z2luLWFkYXB0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbGliL3BsdWdpbi1hZGFwdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDZEQUF5RDtBQUN6RCw2REFBeUQ7QUFDekQseURBQXFEO0FBQ3JELHFEQUFtSDtBQUNuSCwrQ0FBMkM7QUFHM0MsdUNBQW9DO0FBRXBDOzs7O0dBSUc7QUFDSCxNQUFhLGFBQWE7SUFXeEI7Ozs7O09BS0c7SUFDSCxZQUFZLEtBQWM7UUFDeEIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLElBQUksSUFBSSxHQUFHLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNsRixJQUFJLENBQUMsUUFBUSxHQUFHLG9CQUFRLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDdkMsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLDBCQUFXLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQy9DLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLDBCQUFXLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxhQUFhLENBQUMsaUJBQWlCLENBQUMsQ0FBQztRQUN2RixJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksOEJBQWEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDbkQsSUFBSSxDQUFDLG1CQUFtQixHQUFHLElBQUksOEJBQWEsQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHLGFBQWEsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBQzNGLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSw4QkFBYSxDQUFDLElBQUksQ0FBQyxLQUFLLEdBQUcsYUFBYSxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFFckYsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsMENBQTBDLENBQUMsQ0FBQztRQUVsRSxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyw0QkFBYSxFQUFFLHdCQUFTLEVBQUUsNEJBQWEsQ0FBQyxDQUFDO1FBQzlELElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLDJCQUFZLEVBQUUsdUJBQVEsRUFBRSwyQkFBWSxDQUFDLENBQUM7SUFDN0QsQ0FBQztJQUVEOzs7Ozs7Ozs7T0FTRztJQUNILElBQUksQ0FDRixNQUFNLEdBQUcsS0FBSyxFQUNkLE9BQU8sR0FBRyxLQUFLLEVBQ2YsUUFBUSxHQUFHLElBQUk7UUFNZixNQUFNLE9BQU8sR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQztRQUNuRSxPQUFPLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxFQUFFLEVBQUU7WUFDOUQsSUFBSSxNQUFNLEVBQUU7Z0JBQ1YsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7YUFDL0M7WUFDRCxPQUFPLEVBQUUsTUFBTSxFQUFFLFdBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxDQUFDO1FBQzlELENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVEOzs7Ozs7Ozs7OztPQVdHO0lBQ0gsTUFBTSxDQUFDLEVBQTBFLEVBQUUsUUFBUSxHQUFHLElBQUk7UUFDaEcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsRUFBRSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ3pDLE9BQU8sR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLEVBQUUsQ0FBQztJQUMvQyxDQUFDO0lBRUQ7Ozs7Ozs7T0FPRztJQUNILGFBQWEsQ0FBQyxNQUFNLEdBQUcsS0FBSyxFQUFFLFNBQVMsR0FBRyxNQUFNO1FBQzlDLE1BQU0sT0FBTyxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDO1FBQ3ZFLE9BQU8sQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQy9CLE9BQU8sR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxDQUFDO0lBQ3BDLENBQUM7O0FBekZILHNDQTBGQztBQXpGeUIsK0JBQWlCLEdBQVcsTUFBTSxDQUFDIn0=