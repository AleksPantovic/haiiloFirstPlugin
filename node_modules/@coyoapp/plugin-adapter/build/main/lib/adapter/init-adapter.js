"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.InitAdapter = void 0;
const error_handlers_1 = require("../error/error-handlers");
const plugin_error_1 = require("../error/plugin-error");
const jwk_store_1 = require("../jwt/jwk-store");
const jwt_handler_1 = require("../jwt/jwt-handler");
const random_1 = require("../utils/random");
/**
 * Service class to initialize a plug-in and retrieve initialization response
 * information.
 */
class InitAdapter {
    /**
     * Creates a new instance of this class.
     *
     * @param srcId the plug-in source ID to use for requests
     * @returns the new instance
     */
    constructor(srcId) {
        this.srcId = srcId;
        this.jwkStore = jwk_store_1.JwkStore.getInstance();
        this.jwtHandler = new jwt_handler_1.JwtHandler();
    }
    /**
     * Sends an initialization message to the parent window (i.e. COYO)
     * and retrieves the response.
     *
     * @param timeout a maximum time to wait for the response
     * @param validate a flag indicating if the JWT response should be validated
     * @returns a promise holding the decoded (and possibly validated) JWT claims
     */
    send(timeout, validate) {
        return new Promise((resolve, reject) => {
            let listener = null;
            let timer = null;
            const clear = () => {
                if (listener !== null) {
                    window.removeEventListener('message', listener);
                }
                if (timer !== null) {
                    clearTimeout(timer);
                }
            };
            const jti = random_1.randomStr();
            listener = (event) => {
                const claims = this.jwtHandler.decodeJwtClaims(event.data);
                if (claims && claims.jti === jti) {
                    clear();
                    if (validate) {
                        this.jwtHandler
                            .validateJwt(claims, { sub: InitAdapter.REQ_SUBJECT })
                            .then(() => {
                            const header = this.jwtHandler.decodeJwtHeader(event.data);
                            return this.jwkStore
                                .getJwk(claims.iss || '', header ? header.jku : undefined)
                                .then(keys => this.jwtHandler.verifyJwt(event.data, ...keys))
                                .catch(err => (err.recover ? error_handlers_1.showErrorAndRecover(err, void 0) : Promise.reject(err)));
                        })
                            .then(() => resolve([claims, event.data]))
                            .catch(err => error_handlers_1.showError(err));
                    }
                    else {
                        resolve([claims, event.data]);
                    }
                }
            };
            timer = window.setTimeout(() => {
                clear();
                reject(new plugin_error_1.PluginError(plugin_error_1.PluginErrorCode.MessageTimeout, `Initialization timed out after ${timeout}ms`));
            }, timeout);
            window.addEventListener('message', listener);
            parent.postMessage({ iss: this.srcId, sub: InitAdapter.RES_SUBJECT, jti }, '*');
        });
    }
}
exports.InitAdapter = InitAdapter;
InitAdapter.REQ_SUBJECT = 'init';
InitAdapter.RES_SUBJECT = 'init';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5pdC1hZGFwdGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2xpYi9hZGFwdGVyL2luaXQtYWRhcHRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSw0REFBeUU7QUFDekUsd0RBQXFFO0FBQ3JFLGdEQUE0QztBQUU1QyxvREFBZ0Q7QUFDaEQsNENBQTRDO0FBRTVDOzs7R0FHRztBQUNILE1BQWEsV0FBVztJQU10Qjs7Ozs7T0FLRztJQUNILFlBQTZCLEtBQWE7UUFBYixVQUFLLEdBQUwsS0FBSyxDQUFRO1FBQ3hDLElBQUksQ0FBQyxRQUFRLEdBQUcsb0JBQVEsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUN2QyxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksd0JBQVUsRUFBRSxDQUFDO0lBQ3JDLENBQUM7SUFFRDs7Ozs7OztPQU9HO0lBQ0gsSUFBSSxDQUFDLE9BQWUsRUFBRSxRQUFpQjtRQUNyQyxPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ3JDLElBQUksUUFBUSxHQUEyQyxJQUFJLENBQUM7WUFDNUQsSUFBSSxLQUFLLEdBQWtCLElBQUksQ0FBQztZQUNoQyxNQUFNLEtBQUssR0FBRyxHQUFHLEVBQUU7Z0JBQ2pCLElBQUksUUFBUSxLQUFLLElBQUksRUFBRTtvQkFDckIsTUFBTSxDQUFDLG1CQUFtQixDQUFDLFNBQVMsRUFBRSxRQUFRLENBQUMsQ0FBQztpQkFDakQ7Z0JBQ0QsSUFBSSxLQUFLLEtBQUssSUFBSSxFQUFFO29CQUNsQixZQUFZLENBQUMsS0FBSyxDQUFDLENBQUM7aUJBQ3JCO1lBQ0gsQ0FBQyxDQUFDO1lBRUYsTUFBTSxHQUFHLEdBQUcsa0JBQVMsRUFBRSxDQUFDO1lBQ3hCLFFBQVEsR0FBRyxDQUFDLEtBQW1CLEVBQUUsRUFBRTtnQkFDakMsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUMzRCxJQUFJLE1BQU0sSUFBSSxNQUFNLENBQUMsR0FBRyxLQUFLLEdBQUcsRUFBRTtvQkFDaEMsS0FBSyxFQUFFLENBQUM7b0JBQ1IsSUFBSSxRQUFRLEVBQUU7d0JBQ1osSUFBSSxDQUFDLFVBQVU7NkJBQ1osV0FBVyxDQUFDLE1BQU0sRUFBRSxFQUFFLEdBQUcsRUFBRSxXQUFXLENBQUMsV0FBVyxFQUFFLENBQUM7NkJBQ3JELElBQUksQ0FBQyxHQUFHLEVBQUU7NEJBQ1QsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDOzRCQUMzRCxPQUFPLElBQUksQ0FBQyxRQUFRO2lDQUNqQixNQUFNLENBQUMsTUFBTSxDQUFDLEdBQUcsSUFBSSxFQUFFLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7aUNBQ3pELElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQztpQ0FDNUQsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxvQ0FBbUIsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQzFGLENBQUMsQ0FBQzs2QkFDRCxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDOzZCQUN6QyxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQywwQkFBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7cUJBQ2pDO3lCQUFNO3dCQUNMLE9BQU8sQ0FBQyxDQUFDLE1BQU0sRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztxQkFDL0I7aUJBQ0Y7WUFDSCxDQUFDLENBQUM7WUFFRixLQUFLLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUU7Z0JBQzdCLEtBQUssRUFBRSxDQUFDO2dCQUNSLE1BQU0sQ0FBQyxJQUFJLDBCQUFXLENBQUMsOEJBQWUsQ0FBQyxjQUFjLEVBQUUsa0NBQWtDLE9BQU8sSUFBSSxDQUFDLENBQUMsQ0FBQztZQUN6RyxDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFFWixNQUFNLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBQzdDLE1BQU0sQ0FBQyxXQUFXLENBQUMsRUFBRSxHQUFHLEVBQUUsSUFBSSxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsV0FBVyxDQUFDLFdBQVcsRUFBRSxHQUFHLEVBQUUsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUNsRixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7O0FBckVILGtDQXNFQztBQXJFeUIsdUJBQVcsR0FBRyxNQUFNLENBQUM7QUFDckIsdUJBQVcsR0FBRyxNQUFNLENBQUMifQ==